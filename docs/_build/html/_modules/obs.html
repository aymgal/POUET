

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>obs &mdash; POUET 0.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="POUET 0.2 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> POUET
          

          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">POUET</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>obs</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for obs</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Define the Observable class, the standard object of pouet, and related functions</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">cos</span><span class="p">,</span> <span class="n">rad2deg</span><span class="p">,</span> <span class="n">isnan</span><span class="p">,</span> <span class="n">arange</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span> <span class="k">as</span> <span class="nn">pythoncopy</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="k">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">angles</span><span class="p">,</span> <span class="n">angle_utilities</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">importlib</span>

<span class="kn">import</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">clouds</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Observable"><a class="viewcode-back" href="../source/pouet.html#obs.Observable">[docs]</a><span class="k">class</span> <span class="nc">Observable</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Class to hold a specific target from any observational progamm</span>

<span class="sd">	Unvariable parameters are defined at initialisation</span>

<span class="sd">	Variable parameters (distance to moon, azimuth, observability,...) are undefined until associated methods are called</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;emptyobservable&#39;</span><span class="p">,</span> <span class="n">obsprogram</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
				<span class="n">minangletomoon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxairmass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exptime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>


		<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">obsprogram</span> <span class="o">=</span> <span class="n">obsprogram</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsprogram</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">module_name</span> <span class="o">=</span> <span class="s2">&quot;obsprogram.prog</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obsprogram</span><span class="p">)</span>
				<span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obsprogram</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span>
				<span class="n">program</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">minangletomoon</span> <span class="o">=</span> <span class="n">program</span><span class="o">.</span><span class="n">minangletomoon</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">maxairmass</span> <span class="o">=</span> <span class="n">program</span><span class="o">.</span><span class="n">maxairmass</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">exptime</span> <span class="o">=</span> <span class="n">program</span><span class="o">.</span><span class="n">exptime</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">program</span> <span class="o">=</span> <span class="n">program</span>
			<span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">program</span> <span class="o">=</span> <span class="kc">None</span>
				<span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;I could not find the prog</span><span class="si">%s</span><span class="s2">.py definition file in obsprogram/&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsprogram</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">Angle</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">Angle</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;degree&quot;</span><span class="p">)</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">minangletomoon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">minangletomoon</span> <span class="o">=</span> <span class="n">minangletomoon</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">maxairmass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxairmass</span> <span class="o">=</span> <span class="n">maxairmass</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">exptime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exptime</span> <span class="o">=</span> <span class="n">exptime</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cloudfree</span> <span class="o">=</span> <span class="kc">None</span>
	
		<span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span>
		<span class="c1">#self.observability = observability</span>



	<span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

		<span class="c1"># not very elegant</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">30</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Name:</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">Program:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">Alpha:</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> \
				  <span class="s2">&quot;Delta:</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsprogram</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>

		<span class="k">try</span><span class="p">:</span>
			<span class="n">msg</span><span class="o">+=</span> <span class="s2">&quot;Altitude:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">altitude</span><span class="o">.</span><span class="n">degree</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="n">msg</span><span class="o">+=</span> <span class="s2">&quot;Altitude:</span><span class="se">\t</span><span class="s2">None</span><span class="se">\n</span><span class="s2">&quot;</span>

		<span class="k">try</span><span class="p">:</span>	<span class="c1"># let&#39;s behave like real people and use a correct iso system</span>

			<span class="n">msg</span><span class="o">+=</span> <span class="s2">&quot;Azimuth:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">azimuth</span><span class="o">.</span><span class="n">degree</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="n">msg</span><span class="o">+=</span> <span class="s2">&quot;Azimuth:</span><span class="se">\t</span><span class="s2">None</span><span class="se">\n</span><span class="s2">&quot;</span>

		<span class="k">try</span><span class="p">:</span>
			<span class="n">msg</span><span class="o">+=</span> <span class="s2">&quot;Airmass:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="n">msg</span><span class="o">+=</span> <span class="s2">&quot;Airmass:</span><span class="se">\t</span><span class="s2">None</span><span class="se">\n</span><span class="s2">&quot;</span>


		<span class="k">return</span> <span class="n">msg</span>


<div class="viewcode-block" id="Observable.copy"><a class="viewcode-back" href="../source/pouet.html#obs.Observable.copy">[docs]</a>	<span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">pythoncopy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Observable.compute_angletomoon"><a class="viewcode-back" href="../source/pouet.html#obs.Observable.compute_angletomoon">[docs]</a>	<span class="k">def</span> <span class="nf">compute_angletomoon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meteo</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Compute the distance to the moon</span>

<span class="sd">		:param meteo:</span>
<span class="sd">		:return:</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="n">moonalt</span><span class="p">,</span> <span class="n">moonaz</span> <span class="o">=</span> <span class="n">meteo</span><span class="o">.</span><span class="n">moonalt</span><span class="p">,</span> <span class="n">meteo</span><span class="o">.</span><span class="n">moonaz</span>
		<span class="n">alt</span><span class="p">,</span> <span class="n">az</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">altitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azimuth</span>
		<span class="n">separation</span> <span class="o">=</span> <span class="n">angle_utilities</span><span class="o">.</span><span class="n">angular_separation</span><span class="p">(</span><span class="n">moonaz</span><span class="p">,</span> <span class="n">moonalt</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span> <span class="c1"># Warning, separation is in radian!!</span>

		<span class="n">angletomoon</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">Angle</span><span class="p">(</span><span class="n">separation</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;radian&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">angletomoon</span> <span class="o">=</span> <span class="n">angletomoon</span></div>


<div class="viewcode-block" id="Observable.compute_angletosun"><a class="viewcode-back" href="../source/pouet.html#obs.Observable.compute_angletosun">[docs]</a>	<span class="k">def</span> <span class="nf">compute_angletosun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meteo</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		compute distance to the Sun</span>

<span class="sd">		:param meteo:</span>
<span class="sd">		:return:</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="n">sunalt</span><span class="p">,</span> <span class="n">sunaz</span> <span class="o">=</span> <span class="n">meteo</span><span class="o">.</span><span class="n">sunalt</span><span class="p">,</span> <span class="n">meteo</span><span class="o">.</span><span class="n">sunaz</span>
		<span class="n">alt</span><span class="p">,</span> <span class="n">az</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">altitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">azimuth</span>
		<span class="n">separation</span> <span class="o">=</span> <span class="n">angle_utilities</span><span class="o">.</span><span class="n">angular_separation</span><span class="p">(</span><span class="n">sunaz</span><span class="p">,</span> <span class="n">sunalt</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span> <span class="c1"># Warning, separation is in radian!!</span>

		<span class="n">angletosun</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">Angle</span><span class="p">(</span><span class="n">separation</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;radian&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">angletosun</span> <span class="o">=</span> <span class="n">angletosun</span></div>


<div class="viewcode-block" id="Observable.compute_angletowind"><a class="viewcode-back" href="../source/pouet.html#obs.Observable.compute_angletowind">[docs]</a>	<span class="k">def</span> <span class="nf">compute_angletowind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meteo</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Actualize the angle to wind, from the most recent meteo update and altitude and azimuth computed</span>

<span class="sd">		WARNING : you need to actualize the meteo and altaz by yourself before calling this function !</span>

<span class="sd">		TODO: implement a warning flag when the wind is above pointing limit...? or do it somewhere else ?</span>

<span class="sd">		:param meteo: a Meteo object, from where I get the wind</span>

<span class="sd">		:return: actualize angle to wind and return it</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="n">winddirection</span> <span class="o">=</span> <span class="n">meteo</span><span class="o">.</span><span class="n">winddirection</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">angletowind</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">winddirection</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">azimuth</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">angletowind</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">Angle</span><span class="p">(</span><span class="n">angletowind</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">)</span>


		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no azimuth! </span><span class="se">\n</span><span class="s2"> Compute its azimuth first !&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Observable.compute_altaz"><a class="viewcode-back" href="../source/pouet.html#obs.Observable.compute_altaz">[docs]</a>	<span class="k">def</span> <span class="nf">compute_altaz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meteo</span><span class="p">,</span> <span class="n">obs_time</span><span class="o">=</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Actualize altitude and azimuth of the observable at the given observation time.</span>

<span class="sd">		:param obs_time: time of observation. Default = current execution time</span>
<span class="sd">		:return: actualise altitude and azimuth for obs_time, and return them</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">azimuth</span><span class="p">,</span> <span class="n">altitude</span> <span class="o">=</span> <span class="n">meteo</span><span class="o">.</span><span class="n">get_AzAlt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="n">obs_time</span><span class="o">=</span><span class="n">obs_time</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">altitude</span> <span class="o">=</span> <span class="n">altitude</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">azimuth</span> <span class="o">=</span> <span class="n">azimuth</span></div>


<div class="viewcode-block" id="Observable.compute_airmass"><a class="viewcode-back" href="../source/pouet.html#obs.Observable.compute_airmass">[docs]</a>	<span class="k">def</span> <span class="nf">compute_airmass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meteo</span><span class="p">):</span>

		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Compute the airmass using the altitude. We cap the maximum value at 10.</span>

<span class="sd">		:return: actualize airmass and return it</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">airmass</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">elev2airmass</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">altitude</span><span class="o">.</span><span class="n">radian</span><span class="p">,</span> <span class="n">meteo</span><span class="o">.</span><span class="n">elev</span><span class="p">)</span>


			<span class="sd">&quot;&quot;&quot;	</span>
<span class="sd">			zenith = angles.Angle(90-self.altitude.degree, unit=&quot;degree&quot;)</span>
<span class="sd">			airmass = 1.0/cos(zenith.radian)</span>
<span class="sd">			if airmass &lt; 0 or airmass &gt; 10:</span>
<span class="sd">				airmass = 10</span>
<span class="sd">			self.airmass = airmass</span>
<span class="sd">			&quot;&quot;&quot;</span>

		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no altitude! </span><span class="se">\n</span><span class="s2"> Compute its altutide first !&quot;</span><span class="p">)</span></div>
		
<div class="viewcode-block" id="Observable.is_cloudfree"><a class="viewcode-back" href="../source/pouet.html#obs.Observable.is_cloudfree">[docs]</a>	<span class="k">def</span> <span class="nf">is_cloudfree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meteo</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Computes whether the pointing direction is cloudy according to the altaz coordinates in memeory</span>
<span class="sd">		</span>
<span class="sd">		:return: actualize is_cloudfree (1: no cloud, 0: cloudy)</span>
<span class="sd">		</span>
<span class="sd">		:note: if unavailable, returns 2: connection error, if error during computation of observability from map: 3</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="n">ERROR_CONN</span> <span class="o">=</span> <span class="mf">2.</span>
		<span class="n">ERROR_COMPUTE</span> <span class="o">=</span> <span class="mf">3.</span>

		<span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span> <span class="o">=</span> <span class="n">clouds</span><span class="o">.</span><span class="n">get_image_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">azimuth</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">altitude</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">meteo</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="n">meteo</span><span class="o">.</span><span class="n">cloudmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cloudfree</span> <span class="o">=</span> <span class="n">ERROR_CONN</span>
			<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No cloud map in meteo object&quot;</span><span class="p">)</span>
			<span class="k">return</span>
		
		<span class="k">try</span><span class="p">:</span>
			<span class="n">xpix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xpix</span><span class="p">))</span>
			<span class="n">ypix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ypix</span><span class="p">))</span>
		<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cloudfree</span> <span class="o">=</span> <span class="n">ERROR_COMPUTE</span>
		
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloudfree</span> <span class="o">!=</span> <span class="n">ERROR_COMPUTE</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">cloudfree</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">meteo</span><span class="o">.</span><span class="n">cloudmap</span><span class="p">[</span><span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># Otherwise some 1.0000002 errors arise...</span>
			<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">cloudfree</span> <span class="o">=</span> <span class="n">ERROR_COMPUTE</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloudfree</span> <span class="o">==</span> <span class="n">ERROR_COMPUTE</span><span class="p">:</span> 
			<span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Computation error in clouds&quot;</span><span class="p">)</span>
			
		<span class="bp">self</span><span class="o">.</span><span class="n">cloudfree</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloudfree</span><span class="p">)</span></div>


<div class="viewcode-block" id="Observable.update"><a class="viewcode-back" href="../source/pouet.html#obs.Observable.update">[docs]</a>	<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meteo</span><span class="p">):</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">compute_altaz</span><span class="p">(</span><span class="n">meteo</span><span class="p">,</span> <span class="n">obs_time</span><span class="o">=</span><span class="n">meteo</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">compute_angletowind</span><span class="p">(</span><span class="n">meteo</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">compute_airmass</span><span class="p">(</span><span class="n">meteo</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">compute_angletomoon</span><span class="p">(</span><span class="n">meteo</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">compute_angletosun</span><span class="p">(</span><span class="n">meteo</span><span class="p">)</span></div>


<div class="viewcode-block" id="Observable.compute_observability"><a class="viewcode-back" href="../source/pouet.html#obs.Observable.compute_observability">[docs]</a>	<span class="k">def</span> <span class="nf">compute_observability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meteo</span><span class="p">,</span> <span class="n">displayall</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cloudscheck</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Compute the observability, a value between 0 and 1 that tells if the target can be observed at a given time. Also define flags for each situation (moon, wind, etc...)</span>

<span class="sd">		The closer to 1 the better</span>
<span class="sd">		0 is impossible to observe</span>

<span class="sd">		&quot;&quot;&quot;</span>



		<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;current time is </span><span class="si">%s</span><span class="s2">&quot;</span>  <span class="o">%</span> <span class="n">meteo</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meteo</span><span class="o">=</span><span class="n">meteo</span><span class="p">)</span>
		<span class="n">observability</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># by default, we can observe</span>

		<span class="c1"># Let&#39;s start with a simple yes/no version</span>
		<span class="c1"># We add a small message to display if it&#39;s impossible to observe:</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
		<span class="n">warnings</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

		<span class="c1">### General conditions:</span>
		<span class="c1"># Each condition has an associated bool flag to tell if it is respected or not</span>
		<span class="c1"># Not respected conditions decrease the overall observability by a given amount</span>
		<span class="c1"># todo: configure the observability amount decrease in the obsprogram files.</span>

		<span class="c1"># check the	moondistance:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">obs_moondist</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angletomoon</span><span class="o">.</span><span class="n">degree</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">minangletomoon</span><span class="p">:</span>
			<span class="n">observability</span> <span class="o">-=</span> <span class="mf">0.2</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">obs_moondist</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">MoonDist:</span><span class="si">%0.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">angletomoon</span><span class="o">.</span><span class="n">degree</span>

		<span class="c1"># high airmass</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">obs_highairmass</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">obs_highairmass</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="n">observability</span> <span class="o">-=</span> <span class="mf">0.3</span>
			<span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Airmass:</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span>

		<span class="c1"># check the airmass:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">obs_airmass</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxairmass</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">obs_airmass</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="n">observability</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Airmass:</span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span>

		<span class="c1"># check the wind:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">obs_wind</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angletowind</span><span class="o">.</span><span class="n">degree</span> <span class="o">&lt;</span> <span class="mi">90</span> <span class="ow">and</span> <span class="n">meteo</span><span class="o">.</span><span class="n">windspeed</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">obs_wind</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="n">observability</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WA:</span><span class="si">%0.1f</span><span class="s1">/WS:</span><span class="si">%0.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angletowind</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">meteo</span><span class="o">.</span><span class="n">windspeed</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">meteo</span><span class="o">.</span><span class="n">windspeed</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">obs_wind</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="n">observability</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WS:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">meteo</span><span class="o">.</span><span class="n">windspeed</span>

		<span class="c1"># check the clouds</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">obs_clouds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_clouds_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
		<span class="k">if</span> <span class="n">cloudscheck</span> <span class="ow">and</span> <span class="n">observability</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">is_cloudfree</span><span class="p">(</span><span class="n">meteo</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloudfree</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">obs_clouds</span> <span class="o">=</span> <span class="kc">False</span>
				<span class="n">warnings</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning ! It might be cloudy&#39;</span>
			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloudfree</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">:</span>
				<span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Seems to be cloud-free&#39;</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">obs_clouds_info</span> <span class="o">=</span> <span class="kc">False</span>
				<span class="n">warnings</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No cloud info&#39;</span>

		<span class="c1"># check the internal observability flag</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">obs_internal</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;internalobs&#39;</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">internalobs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">obs_internal</span> <span class="o">=</span> <span class="kc">False</span>
				<span class="n">observability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internalobs</span>
				<span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Spreadsheet NO&#39;</span>


		<span class="c1">### Program specific conditions:</span>
		<span class="n">pobs</span><span class="p">,</span> <span class="n">pmsg</span><span class="p">,</span> <span class="n">pwarn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="o">.</span><span class="n">observability</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="n">meteo</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">pobs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">observability</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">msg</span> <span class="o">+=</span> <span class="n">pmsg</span>
		<span class="n">warnings</span> <span class="o">+=</span> <span class="n">pwarn</span>

		<span class="c1"># Finally, add the eventuel comment:</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">):</span>
			<span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span>

		<span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
			<span class="n">to_print</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> | </span><span class="si">%s</span><span class="se">\n</span><span class="s2">alpha=</span><span class="si">%s</span><span class="s2">, delta=</span><span class="si">%s</span><span class="se">\n</span><span class="s2">az=</span><span class="si">%0.2f</span><span class="s2">, alt=</span><span class="si">%0.2f%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">meteo</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">iso</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="n">rad2deg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">azimuth</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">rad2deg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">altitude</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">observability</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">((</span><span class="n">util</span><span class="o">.</span><span class="n">hilite</span><span class="p">(</span><span class="n">to_print</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)))</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">warnings</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="nb">print</span><span class="p">((</span><span class="n">util</span><span class="o">.</span><span class="n">hilite</span><span class="p">(</span><span class="n">warnings</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span>
				<span class="nb">print</span><span class="p">((</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">20</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">displayall</span><span class="p">:</span>
					<span class="nb">print</span><span class="p">((</span><span class="n">util</span><span class="o">.</span><span class="n">hilite</span><span class="p">(</span><span class="n">to_print</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">warnings</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="nb">print</span><span class="p">((</span><span class="n">util</span><span class="o">.</span><span class="n">hilite</span><span class="p">(</span><span class="n">warnings</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span>
					<span class="nb">print</span><span class="p">((</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">20</span><span class="p">))</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">pass</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">observability</span> <span class="o">=</span> <span class="n">observability</span></div></div>


<div class="viewcode-block" id="showstatus"><a class="viewcode-back" href="../source/pouet.html#obs.showstatus">[docs]</a><span class="k">def</span> <span class="nf">showstatus</span><span class="p">(</span><span class="n">observables</span><span class="p">,</span> <span class="n">meteo</span><span class="p">,</span> <span class="n">obs_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">displayall</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cloudscheck</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Using a list of observables, print their observability at the given obs_time. The moon position </span>
<span class="sd">	and all observables are updated according to the given obs_time. The wind is always taken at </span>
<span class="sd">	the current time.</span>

<span class="sd">	displayall = True allows all the targets to be displayed, even if they cannot be observed</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># NO, we keep meteo update outside obs functions !</span>
	<span class="c1"># meteo.update(obs_time=obs_time)</span>
	<span class="k">for</span> <span class="n">observable</span> <span class="ow">in</span> <span class="n">observables</span><span class="p">:</span>
		<span class="n">observable</span><span class="o">.</span><span class="n">compute_observability</span><span class="p">(</span><span class="n">meteo</span><span class="o">=</span><span class="n">meteo</span><span class="p">,</span> <span class="n">obs_time</span><span class="o">=</span><span class="n">obs_time</span><span class="p">,</span> <span class="n">displayall</span><span class="o">=</span><span class="n">displayall</span><span class="p">,</span>
								<span class="n">cloudscheck</span><span class="o">=</span><span class="n">cloudscheck</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="shownightobs"><a class="viewcode-back" href="../source/pouet.html#obs.shownightobs">[docs]</a><span class="k">def</span> <span class="nf">shownightobs</span><span class="p">(</span><span class="n">observable</span><span class="p">,</span> <span class="n">meteo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obs_night</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Plot the observability of one observable along the night</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># list of times between nautical twilights</span>
	<span class="n">times</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_nighthours</span><span class="p">(</span><span class="n">obs_night</span><span class="p">)</span>

	<span class="n">mymeteo</span> <span class="o">=</span> <span class="n">pythoncopy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">meteo</span><span class="p">)</span> <span class="c1"># as we don&#39;t want to affect the current meteo, we make a copy that we update with the time</span>

	<span class="n">obss</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">moonseps</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">airmasses</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
		<span class="n">mymeteo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">obs_time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># This is the ONLY function in obs that updates the meteo !!</span>
		<span class="n">observable</span><span class="o">.</span><span class="n">compute_observability</span><span class="p">(</span><span class="n">meteo</span><span class="o">=</span><span class="n">mymeteo</span><span class="p">,</span> <span class="n">obs_time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">displayall</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_clouds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
		<span class="n">observable</span><span class="o">.</span><span class="n">compute_airmass</span><span class="p">()</span>
		<span class="n">obss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observable</span><span class="o">.</span><span class="n">observability</span><span class="p">)</span>
		<span class="n">moonseps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observable</span><span class="o">.</span><span class="n">angletomoon</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
		<span class="n">airmasses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observable</span><span class="o">.</span><span class="n">airmass</span><span class="p">)</span>


	<span class="c1"># create the x ticks labels every hour</span>
	<span class="n">Time</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> 05:00:00&#39;</span> <span class="o">%</span> <span class="n">obs_night</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;iso&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
	<span class="n">hstart</span><span class="o">=</span><span class="mi">22</span>
	<span class="n">hend</span><span class="o">=</span><span class="mi">12</span>
	<span class="n">nhbm</span> <span class="o">=</span> <span class="mi">24</span><span class="o">-</span><span class="n">hstart</span>  <span class="c1"># number of hours before midnight...</span>
	<span class="n">myhours</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="n">nhbm</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
		<span class="n">myhours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="p">(</span><span class="n">hour</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
	<span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="n">hend</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
		<span class="n">myhours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span>

	<span class="n">myhours</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%02i</span><span class="s2">:00:00&quot;</span> <span class="o">%</span> <span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">myhours</span><span class="p">]</span>
	<span class="n">mytimes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Time</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obs_night</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;iso&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">myhours</span><span class="p">[:</span><span class="n">nhbm</span><span class="p">]]</span>

	<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">myhours</span><span class="p">[</span><span class="n">nhbm</span><span class="p">:]:</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obs_night</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;iso&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">mjd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
		<span class="n">mytimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

	<span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mjd</span>
	<span class="n">xmax</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">obss</span><span class="p">)</span>
	<span class="n">xs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">t</span><span class="o">.</span><span class="n">mjd</span><span class="o">-</span><span class="n">tmin</span><span class="p">)</span><span class="o">*</span><span class="n">xmax</span><span class="o">/</span><span class="p">(</span><span class="n">tmax</span><span class="o">-</span><span class="n">tmin</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mytimes</span><span class="p">]</span>
	<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">myhours</span><span class="p">]</span>

	<span class="n">starttimes</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">stoptimes</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">obss</span><span class="p">:</span>
		<span class="n">starttimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">obss</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
		<span class="n">stoptimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">obss</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>

	<span class="k">if</span> <span class="mf">0.8</span> <span class="ow">in</span> <span class="n">obss</span><span class="p">:</span>
		<span class="n">starttimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">obss</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)])</span>
		<span class="n">stoptimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">obss</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)])</span>

	<span class="k">if</span> <span class="mf">0.7</span> <span class="ow">in</span> <span class="n">obss</span><span class="p">:</span>
		<span class="n">starttimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">obss</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">0.7</span><span class="p">)])</span>
		<span class="n">stoptimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">obss</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">0.7</span><span class="p">)])</span>

	<span class="k">if</span> <span class="mf">0.5</span> <span class="ow">in</span> <span class="n">obss</span><span class="p">:</span>
		<span class="n">starttimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">obss</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)])</span>
		<span class="n">stoptimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">obss</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)])</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">obss</span> <span class="ow">and</span> <span class="ow">not</span> <span class="mf">0.8</span> <span class="ow">in</span> <span class="n">obss</span> <span class="ow">and</span> <span class="ow">not</span> <span class="mf">0.7</span> <span class="ow">in</span> <span class="n">obss</span> <span class="ow">and</span> <span class="ow">not</span> <span class="mf">0.5</span> <span class="ow">in</span> <span class="n">obss</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not observable tonight !&quot;</span> <span class="o">%</span> <span class="n">observable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
			<span class="k">return</span>

	<span class="n">starttime</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">starttimes</span><span class="p">)</span>
	<span class="n">stoptime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">stoptimes</span><span class="p">)</span>

	<span class="c1"># shift the start and stoptime if needed</span>
	<span class="k">if</span> <span class="n">starttime</span><span class="o">.</span><span class="n">mjd</span> <span class="o">&gt;</span> <span class="n">stoptime</span><span class="o">.</span><span class="n">mjd</span> <span class="o">-</span> <span class="p">(</span><span class="n">observable</span><span class="o">.</span><span class="n">exptime</span><span class="o">/</span><span class="mf">60.</span><span class="o">/</span><span class="mf">1440.</span><span class="p">):</span>
		<span class="n">starttime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">stoptime</span><span class="o">.</span><span class="n">mjd</span> <span class="o">-</span> <span class="p">(</span><span class="n">observable</span><span class="o">.</span><span class="n">exptime</span><span class="o">/</span><span class="mf">60.</span><span class="o">/</span><span class="mf">1440.</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">stoptime</span><span class="o">.</span><span class="n">mjd</span> <span class="o">&lt;</span> <span class="n">starttime</span><span class="o">.</span><span class="n">mjd</span> <span class="o">+</span> <span class="p">(</span><span class="n">observable</span><span class="o">.</span><span class="n">exptime</span><span class="o">/</span><span class="mf">60.</span><span class="o">/</span><span class="mf">1440.</span><span class="p">):</span>
		<span class="n">stoptime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">starttime</span><span class="o">.</span><span class="n">mjd</span> <span class="o">+</span> <span class="p">(</span><span class="n">observable</span><span class="o">.</span><span class="n">exptime</span><span class="o">/</span><span class="mf">60.</span><span class="o">/</span><span class="mf">1440.</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>

	<span class="n">starttime</span> <span class="o">=</span> <span class="n">starttime</span><span class="o">.</span><span class="n">iso</span>
	<span class="n">stoptime</span> <span class="o">=</span> <span class="n">stoptime</span><span class="o">.</span><span class="n">iso</span>



	<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mf">1.3</span><span class="p">))</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.45</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
	<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">xticks</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obss</span><span class="p">))</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
	<span class="c1"># green, everything is fine</span>
	<span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">obss</span><span class="p">:</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">obss</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">obss</span><span class="p">)</span><span class="o">-</span><span class="n">obss</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;chartreuse&#39;</span><span class="p">)</span>
	<span class="c1"># blue, problem with moon sep, airmass or both. #todo: code that better</span>
	<span class="k">if</span> <span class="mf">0.8</span> <span class="ow">in</span> <span class="n">obss</span><span class="p">:</span>
		<span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;royalblue&quot;</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">obss</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">0.8</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">obss</span><span class="p">)</span><span class="o">-</span><span class="n">obss</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">0.8</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Moonsep = </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">moonseps</span><span class="p">))</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">),</span>  <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
	<span class="k">if</span> <span class="mf">0.7</span> <span class="ow">in</span> <span class="n">obss</span><span class="p">:</span>
		<span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;royalblue&quot;</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">obss</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">0.7</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">obss</span><span class="p">)</span><span class="o">-</span><span class="n">obss</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">0.7</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Airmass &gt; 1.5&quot;</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">),</span>  <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

	<span class="k">if</span> <span class="mf">0.5</span> <span class="ow">in</span> <span class="n">obss</span><span class="p">:</span>
		<span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;indianred&quot;</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">obss</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">obss</span><span class="p">)</span><span class="o">-</span><span class="n">obss</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;indianred&#39;</span><span class="p">)</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Moonsep = </span><span class="si">%i</span><span class="s2">, Airmass &gt; 1.5&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">moonseps</span><span class="p">))</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>  <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

	<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">xticks</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xticks</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;UT&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

	<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">observable</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot; (&quot;</span><span class="o">+</span><span class="n">starttime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot; --&gt; &quot;</span><span class="o">+</span><span class="n">stoptime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.93</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
		<span class="k">assert</span> <span class="n">dirpath</span> <span class="o">!=</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">obs_night</span><span class="p">)):</span>
			<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">obs_night</span><span class="p">))</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">obs_night</span><span class="p">,</span> <span class="n">observable</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Plot saved on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">))</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="rdbimport"><a class="viewcode-back" href="../source/pouet.html#obs.rdbimport">[docs]</a><span class="k">def</span> <span class="nf">rdbimport</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">namecol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alphacol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">deltacol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">obsprogramcol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">startline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">obsprogram</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Import an rdb catalog into a list of observables</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)))</span>
	<span class="n">rdbfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
	<span class="n">rdbfilelines</span> <span class="o">=</span> <span class="n">rdbfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="n">startline</span><span class="p">:]</span> <span class="c1"># we directly &quot;skip&quot; the first lines of eventual headers</span>
	<span class="n">rdbfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	<span class="n">observables</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rdbfilelines</span><span class="p">)</span> <span class="p">:</span>

		<span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
			<span class="k">continue</span>

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
			<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping empty line </span><span class="si">%i</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ind</span><span class="o">+</span><span class="n">startline</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>
			<span class="k">continue</span>

		<span class="n">elements</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

		<span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">namecol</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">alpha</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">alphacol</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">deltacol</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">obsprogramcol</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">obsprogram</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">obsprogramcol</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
				<span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="c1">#todo: this is not robust against a column with incoherent obsprogram, or with a line without obsprogram. We do not want to load default config under the hood if an obsprogram is wrongly or not given. Maybe we could, but nevertheless warn the user about it in a dedicated popup ?</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;nothing in obsprogramcol - using provided default instead&#39;</span><span class="p">)</span>


		<span class="n">observables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Observable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">obsprogram</span><span class="o">=</span><span class="n">obsprogram</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">))</span>

	<span class="k">return</span> <span class="n">observables</span></div>



<div class="viewcode-block" id="rdbexport"><a class="viewcode-back" href="../source/pouet.html#obs.rdbexport">[docs]</a><span class="k">def</span> <span class="nf">rdbexport</span><span class="p">(</span><span class="n">observables</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">namecol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alphacol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">deltacol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">obsprogramcol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Export a list of observables as an rdb catalogue, to be read again later</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">pass</span></div>


</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Vivien Bonvin, Thibault Kuntzer.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>